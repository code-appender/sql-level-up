# 7장 : 서브쿼리

## 21장 서브쿼리가 일으키는 폐해

1. 서브쿼리의 문제점

서브쿼리가 실체적인 데이터를 저장하고 있지 않다는 점에서 기인한다.

- 연산 비용 추가
- 데이터 I/O 비용발생
- 최적화를 받을 수 없음
    - 옵티마이저가 쿼리를 해석하기 위해 필요한 정보를 서브쿼리에서 얻을 수 없습니다.
1. 서브쿼리 의존증
- 서브쿼리를 사용한 방법
    1. 코드가 복잡해서 읽기 어렵다는 것
    2. 성능
- 상관 서브쿼리는 답이 될 수 없다.
- 윈도우 함수로 결합을 제거
    - 테이블 접근횟수를 1회로 줄이는 것
    - SQL 튜닝에서 가장 중요한 부분 I/O를 줄이는것
1. 장기적 관점에서 리스크 관리 (결합 쿼리 사용시 두개의 불안정 요소가 있습니다)
    - 알고리즘 변동 리스크
        - 테이블의 크기 등을 고려하여 옵티마이저가 자동으로 결정한다. 그러다 양이 늘어나면 sort merge, hash등이 선택된다 이런경우 변동리스크를 안아야 한다.
    - 환경 요인에 의한 지연 리스크
        - 결합을 사용한다는 것은 장기적 관점에서 고려해야 할 리스크가 늘어난다.
        - nested loop 방법은 index가 존재해야하고, sort merge 또는 hash가 선택되어 temp 탈락이 발생하는 경우에 대해서
2. 서브쿼리 의존증
    - 다시 서브쿼리 의존증
    - 레코드 간 비교에도 결합은 불필요

서브쿼리 자체가 나쁜것은 아니다. 써야하는 경우가 잃다.

생각의 보조도구로 생각하고 바텀업 타입의 사고방식과 굉장히 좋은 상성을 가지고 있다.

## 22장 서브쿼리 사용이 더 나은 경우

1. 결합과 집약 순서
    1. 결합 부터 하고 집약을 하는 방법
    2. 집약을 하고 결합하는 방법

선택시 가장 중요한 포인트는 결합 대상 레코드 수이다.

이때 TEMP 탈락이 발생하지 않는다면 집약을 먼저 하고 결합하는것이 좋다.