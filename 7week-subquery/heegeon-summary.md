# 서브쿼리

## 1. 서브쿼리가 일으키는 폐해
### 1.1 서브쿼리의 문제점
1. 연산 비용의 추가
    - 서브쿼리는 실체적인 데이터를 저장하고 있지 않기 때문에 서브쿼리에 접근할 때마다 SELECT 구문을 실행해서 데이터를 만들어야 한다.
2. 데이터 I/O 비용 발생
    - 연산의 결과는 어딘가에 저장하기 위해 써두어야 한다.
    - 데이터의 크기가 큰 경우 서브쿼리의 결과 임시 파일에 저장되는 TEMP 탈락이 발행하여 성능이 저하될 수 있다.
3. 최적화를 받을 수 없음
    - 서브쿼리의 결과는 구조상으로 테이블과 다를 바 없지만 제약 또는 인덱스 같은 메타 정보가 저장되지 않는다.
    - 따라서 옵티마이저가 쿼리를 해석하기 위한 정보를 얻을 수 없다.

이러한 단점들 때문에 서브쿼리를 사용하기 전에 반드시 서브쿼리를 사용하지 않으면 해결할 수 없는 문제인지 따져봐야 한다.

### 1.2 서브쿼리 의존증
#### 서브쿼리를 사용하면 단점이 있다.
1. 코드가 여러 계층에 걸쳐 만들어지므로 가독성이 떨어진다.
2. 성능이 떨어진다.

서브쿼리를 사용하지 않고도 같은 결과를 얻을 수 있는 경우가 많다. 그 중에서도 상관 서브쿼리는 답이 될 수 없다.

상관 서브쿼리를 사용하더라도 한 테이블에 대한 접근은 두 번 발생한다.

이러한 문제를 해결하기 위해서는 윈도우 함수를 사용하여 결합을 제거하는 것이 좋다.

#### 윈도우 함수로 결합을 제거
SQL 튜닝에서 가장 중요한 것은 I/O를 줄이는 것이다. 테이블 접근 횟수를 1회로 줄이는 것이 가장 중요하다.

결합을 사용한 쿼리는 두 개의 불안정 요소가 있다.
1. 결합 알고리즘의 변동 리스크
2. 환경 요인에 의한 지연 리스크(인덱스, 메모리, 매개변수 등)

하지만 서브 쿼리가 항상 나쁜 것은 아니다. 써야하는 경우가 있다.

### 1.3 서브쿼리 사용이 더 나은 경우

#### 결합과 집약 순서

두 테이블을 결합한 후 집약을 하는 방법과 집약을 한 후 결합을 하는 것에는 차이가 존재한다.

이때 가장 중요한 포인트는 결합 대상 레코드 수이다.

만약 TEMP 탈락이 발생하지 않는다면 집약을 먼저 하고 결합하는 것을 고려해볼만 하다.
