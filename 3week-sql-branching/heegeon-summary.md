# 3장. SQL의 조건 분기

---

## 3.1 UNION을 사용한 쓸데없이 긴 표현
- UNION을 이용하여 조건 분기를 할 떄에는 WHERE 구만 조금씪 다른 여러 개의 SELECT 구문을 합쳐서 복수의 조건에 일치하는 하나의 결과 집합을 얻는다.
- 하지만 이러한 방법은 외부에서는 여러 개의 SQL을 실행하는 것처럼 보이지만, 내부적으로는 여러 개의 SELECT 구문을 실행하는 계획으로 해석되어 성능적인 측면에서 좋지 못하다.
- 따라서 조건 분기에 UNION을 사용할 지 말 것인지 잘 판단해야 한다.

### 3.1.1 UNION을 사용한 조건 분기와 예제
- UNION을 사용한 조건 분기는 다음과 같이 사용한다.
  ```sql
  SELECT {컬럼명1}, {컬럼명2}, ...
  FROM {테이블명}
  WHERE {조건식1}
  UNION (ALL)
  SELECT {컬럼명1}, {컬럼명2}, ...
  FROM {테이블명}
  WHERE {조건식2};
  ```
  
- 이와 같은 방법은 거의 같은 쿼리를 두 번이나 실행하여 성능이 떨어지고 가독성이 낮은 문제가 있다.
- 모든 RDBMS에서 UNION을 사용한 조건 분기는 테이블에 2번 접근하며 접근마다 풀스캔을 수행한다.

### 3.1.2 WHERE 구에서 조건 분기를 하는 사람 == 초보자
- WHERE 구에서 조건 분기를 하는 것은 초보자가 하는 짓이다.
- 고수는 SELECT 구만으로 조건 분기를 처리한다.
- SELECT 구만으로 조건 분기를 처리하는 방법은 다음과 같다.
  ```sql
  SELECT {컬럼명1}, CASE WHEN {조건식1} THEN {결과1} ELSE {결과2} END AS {컬럼명2}, ...
  FROM {테이블명}
  ```
- CASE 표현식을 사용하여 조건 분기를 처리하면 테이블에 1번만 접근한다.
- 실행 계획을 살펴봄으로써 SQL 구문의 성능을 파악할 수 있지만 이는 RDBMS의 컨셉아 맞지는 않다.
- RDBMS는 사용자가 데이터에 접근 경로라는 물리 레벨의 문제를 의식하지 않도록 하고 싶어한다.

## 3.2 집계와 조건 분기
1. 집계 대상으로 조건 분기
2. 집약 결과로 조건 분기
   - 조건 분기를 Having에서 하는 사람도 초보..
   - COUNT 함수의 리턴값 같은 집약 결과를 CASE 식의 입력으로 사용할 수 있다.

## 3.3 그래도 UNION이 필요한 경우
1. 머지 대상이 되는 SELECT 구문들에서 사용하는 테이블이 다른 경우
2. 테이블이 크고 WHERE 조건으로 선택되는 레코드 수가 충분히 작은 경우

## 3.4 절차 지향형과 선언형

### 3.4.1 구문 기반과 식 기반
- SQL은 절차 지향식으로 작성하기 보다는 선언형으로 작성하는 것이 좋다.

